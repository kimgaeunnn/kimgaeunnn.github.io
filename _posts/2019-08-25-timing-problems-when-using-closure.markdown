---
layout: post
title:  "Preventing Timing Problems When Using Closures"
date:   2019-08-25 18:56:50 +0530
categories: Programming Swift
---

# Preventing Timing Problems When Using Closures

Closureë¥¼ ì‹¤í–‰í•˜ëŠ” ì—¬ëŸ¬ê°œì˜ APIë¥¼ í˜¸ì¶œí–ˆì„ë•Œ, Appì— ë¬´ìŠ¨ì¼ ì´ ìƒê¸¸ê¹Œìš”? Closureë¥¼ ì‚¬ìš©í–ˆì„ ë•Œ ìƒê¸¸ ìˆ˜ ìžˆëŠ” Timing ë¬¸ì œì™€ í•´ê²°ë°©ë²•ì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤ ðŸ˜Ž 



## Overview

Swiftë¥¼ ì´ìš©í•´ API í˜¸ì¶œ ë° ì‘ë‹µì„ ë°›ì„ë•Œ Parameterë¡œ Closureë¥¼ ìžì£¼ ë„˜ê¸°ì£ ! Closureì—ëŠ” ì•±ì˜ ë‹¤ë¥¸ ë¶€ë¶„ê³¼ ìƒí˜¸ìž‘ìš©í•˜ëŠ” ì½”ë“œë¥¼ ë„£ì„ ìˆ˜ ìžˆê¸° ë•Œë¬¸ì—, **APIì— Closerë¥¼ ë‹´ì•„ì„œ ë„˜ê¸°ëŠ” ì—¬ëŸ¬ê°€ì§€ ë°©ë²•**ì— ëŒ€í•´ ì´í•´í•˜ëŠ”ê²Œ ì¤‘ìš”í•©ë‹ˆë‹¤. API í˜¸ì¶œì‹œ ë‹´ê¸´ ClosureëŠ” **ë™ê¸°(ì¦‰ì‹œ), ë¹„ë™ê¸°(ì¼ì •ì‹œê°„ì´ ì§€ë‚œ í›„)**ë¡œ ë¶ˆë¦´ ìˆ˜ ìžˆì£ . ê·¸ë¦¬ê³  **í•œë²ˆ í˜¸ì¶œë ìˆ˜ë„, ì—¬ëŸ¬ë²ˆ í˜¸ì¶œë  ìˆ˜ë„, í˜¸ì¶œì´ ì•ˆë  ìˆ˜ë„** ìžˆìŠµë‹ˆë‹¤. 



> ì¤‘ìš”! 
>
> closureì— ëŒ€í•´ ìž˜ëª»ëœ ê°€ì •ì„ í•˜ê³  í˜¸ì¶œí•˜ë©´, ì•±ì´ ì£½ê±°ë‚˜ data ì¼ê´€ì„±ì´ ê¹¨ì§ˆ ìˆ˜ ìžˆìŠµë‹ˆë‹¤. 



## Understand the Results of Synchronous and Asynchronous Calls

#### ë™ê¸° í˜¸ì¶œê³¼ ë¹„ë™ê¸° í˜¸ì¶œì˜ ê²°ê³¼ì— ëŒ€í•´ ì´í•´í•´ë³´ìž



API í˜¸ì¶œì‹œ closureë¥¼ ë³´ë‚¼ë•Œ, closureê°€ ì•±ë‚´ ë‹¤ë¥¸ ì½”ë“œì™€ ë¹„êµí•´ì„œ **ì–¸ì œ** ë¶ˆë¦´ì§€ë¥¼ ê³ ë ¤í•´ì•¼í•©ë‹ˆë‹¤. ë™ê¸°ì‹ APIì—ì„œëŠ”, clousreë¥¼ ë„˜ê¸°ìžë§ˆìž ì‹¤í–‰ë  ìˆ˜ ìžˆìŠµë‹ˆë‹¤. ê·¸ë¦¬ê³  ë¹„ë™ê¸°ì‹ APIì—ì„œëŠ” ì‹œê°„ì´ ì¡°ê¸ˆ ì§€ë‚˜ë„ result ê°’ ì‚¬ìš©ì´ ë¶ˆê°€í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤. ì´ ì°¨ì´ì ì€ closure ë‚´ì˜ ì½”ë“œì™€ closure ì‹¤í–‰ì— ë’¤ë”°ë¼ì˜¤ëŠ” ì½”ë“œ ëª¨ë‘ë¥¼ ì–´ë–»ê²Œ ì“°ëŠëƒì— ë”°ë¼ ë‹¤ë¥¸ ì˜í–¥ì„ ë¯¸ì¹  ìˆ˜ ìžˆìŠµë‹ˆë‹¤. 



ì•„ëž˜ ì˜ˆì‹œì—ì„œëŠ” *now(_:)*,*later(_:)*ë‘ê°œì˜ í•¨ìˆ˜ë¥¼ ì„ ì–¸í•˜ê³  ìžˆìŠµë‹ˆë‹¤. ë‘ í•¨ìˆ˜ ëª¨ë‘ ë§¤ê°œë³€ìˆ˜ê°€ ì—†ëŠ” trailing closureë¥¼ ì´ìš©í•´ í˜¸ì¶œí•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤. ë‘ í•¨ìˆ˜ ëª¨ë‘ closureë¥¼ í˜¸ì¶œí•˜ê³  ìžˆì§€ë§Œ, *later(_:)* í•¨ìˆ˜ëŠ” closure í˜¸ì¶œ ì „ 2ì´ˆì •ë„ ê¸°ë‹¤ë¦½ë‹ˆë‹¤. 

```swift
import Dispatch
let queue = DispatchQueue(label: "com.example.queue")

func now(_ closure: () -> Void) {
    closure()
}

func later(_ closure: @escaping () -> Void) {
    queue.asyncAfter(deadline: .now() + 2) {
        closure()
    }
}
```

ìœ„ ë‘ í•¨ìˆ˜ëŠ” API í˜¸ì¶œì‹œ ê°€ìž¥ í”í•˜ê²Œ closureë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ì‹ì´ì£  *now(_:)*ëŠ” ë™ê¸°ë°©ì‹, *later(_:)*ëŠ” ë¹„ë™ê¸° ë°©ì‹ê³¼ ìœ ì‚¬í•©ë‹ˆë‹¤. 

Closure í˜¸ì¶œì€ ì•±ì˜ ìƒíƒœë¥¼ ë‚˜íƒ€ë‚´ëŠ” ì§€ì—­/ì „ì—­ë³€ìˆ˜ë¥¼ ë³€ê²½í•  ìˆ˜ ìžˆê¸° ë•Œë¬¸ì—, closureë¥¼ ë„˜ê¸´ ì§í›„ ì½”ë“œë¼ì¸ì€ closureê°€ ì–´ëŠ ì‹œì ì— ë¶ˆë¦´ì§€ ìž˜ ìƒê°í•´ì„œ ì§œì•¼í•©ë‹ˆë‹¤. ê°„ë‹¨í•˜ê²Œ ë¬¸ìžë¥¼ ìˆœì„œëŒ€ë¡œì¶œë ¥í•˜ëŠ” ê¸°ëŠ¥ë„ closure í˜¸ì¶œë¡œ ì¸í•´ ì˜í–¥ë°›ì„ ìˆ˜ ìžˆìŠµë‹ˆë‹¤. 



```swift
later {
    print("A") // "A" ì¼ì • ì‹œì  ì´í›„ ì¶œë ¥
}
print("B") // "B" ë°”ë¡œ ì¶œë ¥

now {
    print("C") // "C" ë°”ë¡œ ì¶œë ¥
}
print("D") // "D" ë°”ë¡œ ì¶œë ¥

// Prevent the program from exiting immediately if you're running this code in Terminal.
let semaphore = DispatchSemaphore(value: 0).wait(timeout: .now() + 10)

// ì¶œë ¥ê²°ê³¼: B C D A
```

 ìœ„ ì˜ˆì‹œì½”ë“œë¥¼ ì‹¤í–‰í•˜ë©´, *B C D A* ìˆœì„œë¡œ ì¶œë ¥ë©ë‹ˆë‹¤. "A" ë¬¸ìž ì¶œë ¥ì½”ë“œê°€ ì œì¼ ìƒë‹¨ì— ì§œì—¬ìžˆì§€ë§Œ, ì¶œë ¥ì—ì„œëŠ” ê°€ìž¥ ë§ˆì§€ë§‰ìž…ë‹ˆë‹¤. ìˆœì„œ ì„žìž„ì€ *now(_:)*,*later(_:)* í•¨ìˆ˜ê°€ ì„ ì–¸ëœ ë°©ì‹ë•Œë¬¸ì— ì¼ì–´ë‚©ë‹ˆë‹¤. ê° í•¨ìˆ˜ê°€ ì–´ë–»ê²Œ closureë¥¼ í˜¸ì¶œí•˜ê³  ì‹¤í–‰ ìˆœì„œê°€ ì–´ë–»ê²Œ ë ì§€ ì•Œê³  ì†ŒìŠ¤ë¥¼ ì§¤ í•„ìš”ê°€ ìžˆìŠµë‹ˆë‹¤. ðŸ˜¶



>  ë©”ëª¨ 
>
> ë‹¤ë¥¸ ë¬¸ìžì™€ ë¹„êµí•´ì„œ Aê°€ í”„ë¦°íŠ¸ë˜ëŠ” ì‹œì ì€ ì–¸ì œë‹¤! ë¼ê³  ë³´ìž¥í•  ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤. ì¼ë°˜ì ì¸ ì‹œìŠ¤í…œ í™˜ê²½ì—ì„œëŠ” ë§ˆì§€ë§‰ì— ì¶œë ¥ë˜ê² ì§€ë§Œ, ë™ê¸°ë¡œ ì‹¤í–‰ë˜ëŠ” ì½”ë“œì™€ ë¹„ë™ê¸°ë¡œ ì‹¤í–‰ë˜ëŠ” ì½”ë“œì˜ ì‹¤í–‰ ìˆœì„œê°€ í•„ìš”í•œ ì½”ë“œëŠ” ì§œì§€ ì•ŠëŠ”ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤. ìŠ¤ë ˆë“œê°„ì˜ ë™ê¸°í™”ë¥¼ í™•ì‹¤ížˆ í•´ì£¼ëŠ” ê²½ìš°ê°€ ì•„ë‹ˆë¼ë©´ìš”!  

API í˜¸ì¶œì‹œ closureë¥¼ ì‚¬ìš©í•  ë•Œì—ëŠ”, ìœ„ì™€ ê°™ì€ ì‹œì /ìˆœì„œ ê¸°ë°˜ì˜ ì´ìŠˆë“¤ì— ëŒ€í•´ ìž˜ ìƒê°í•´ì•¼í•©ë‹ˆë‹¤. ëŒ€ë¶€ë¶„ì˜ ê²½ìš°ì— ì—¬ëŸ¬ë¶„ì˜ ì•±ì—ì„œëŠ” ë”± í•œê°€ì§€ ì‹¤í–‰ ìˆœì„œê°€ ì•Œë§žì€ ê²½ìš°ê°€ ë§Žê¸°ë•Œë¬¸ì—, ì£¼ì–´ì§„ APIë¥¼ ì‚¬ìš©í–ˆì„ë•Œ Appì˜ Stateê°€ ì–´ë–»ê²Œ ë ì§€ì— ëŒ€í•´ ê³ ë¯¼í•˜ëŠ”ê²Œ ì¤‘ìš”í•©ë‹ˆë‹¤. API ì´ë¦„ì´ë‚˜ ë§¤ê°œë³€ìˆ˜ ì´ë¦„ì„ ì§€ì„ë•Œ ë™ê¸°/ë¹„ë™ê¸° ì—¬ë¶€ë¥¼ ëª…ì‹œí•´ ì£¼ëŠ”ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤. 

ìžì£¼ ì¼ì–´ë‚˜ëŠ” íƒ€ì´ë° ê´€ë ¨ ì‹¤ìˆ˜ëŠ”, ë¹„ë™ê¸° í˜¸ì¶œ ê²°ê³¼ê°€ ë™ê¸° í•¨ìˆ˜ í˜¸ì¶œ ì „ì— ì¼ì–´ë‚  ìˆ˜ ìžˆì„ê±°ë¼ê³  ìƒê°í•˜ëŠ” ê²½ìš° ì¼ì–´ë‚©ë‹ˆë‹¤. ì˜ˆë¥¼ë“¤ì–´, *later(_:)* ë©”ì†Œë“œëŠ” ë¹„ë™ê¸° ë°©ì‹ì´ê¸°ë•Œë¬¸ì— [`URLSession`](https://developer.apple.com/documentation/foundation/urlsession)ì˜  [`dataTask(with:completionHandler:)`](https://developer.apple.com/documentation/foundation/urlsession/1410330-datatask) ë©”ì†Œë“œì™€ ë¹„êµ ê°€ëŠ¥í•©ë‹ˆë‹¤. *dataTask(with:completionHandler:)* í•¨ìˆ˜ë¥¼ *viewDidLoad()* ì™€ ê°™ì€ í•¨ìˆ˜ì—ì„œ í˜¸ì¶œí•˜ê³  ê·¸ ê²°ê³¼ë¥¼ closure ë°–ì—ì„œ completion handlerë¥¼ ì´ìš©í•´ ì‚¬ìš©í•˜ëŠ” ë“±ì˜ ì½”ë“œëŠ” ì§œì§€ ë§™ì‹œë‹¤!!! 



## Don't Write Code That Makes a One-Time Change in a Closure That's Called Multiple Times

#### ì—¬ëŸ¬ë²ˆ í˜¸ì¶œë˜ëŠ” Closureì— ì¼íšŒì„± ë³€í™” ì½”ë“œë¥¼ ë„£ì§€ ë§™ì‹œë‹¤ ! 

APIí˜¸ì¶œì‹œ ì—¬ëŸ¬ë²ˆ í˜¸ì¶œ ë˜ëŠ” Closureë¥¼ ì „ë‹¬í–ˆëŠ”ë°, ì™¸ë¶€ Stateë¥¼ ë³€ê²½í•˜ëŠ” ì½”ë“œê°€ ë“¤ì–´ìžˆë‹¤ë©´ ì–´ë–»ê²Œ ë ê¹Œìš”? 

ì•„ëž˜ ì˜ˆì‹œëŠ” [`FileHandle`](https://developer.apple.com/documentation/foundation/filehandle)ì„ ìƒì„±í•˜ê³ , ë°ì´í„° ë°°ì—´ì„ í•´ë‹¹ handleì´ ì°¸ì¡°í•˜ëŠ” íŒŒì¼ì— write í•˜ëŠ” ë‚´ìš©ìž…ë‹ˆë‹¤. 

```swift
import Foundation

let file = FileHandle(forWritingAtPath: "/dev/null")!
let lines = ["x,y", "1,1", "2,4", "3,9", "4,16"]
```

 ê° ë¼ì¸ë“¤ì„ íŒŒì¼ì— ì“°ê¸°ìœ„í•´, *forEach* ë©”ì†Œë“œë¥¼ ì´ìš©í•´ closureë¥¼ ë„˜ê¸°ê³ ìžˆìŠµë‹ˆë‹¤. 

```swift
lines.forEach { line in
    file.write("\(line)\n".data(using: .utf8)!)
}
```

*FileHandle* ì‚¬ìš©ì´ ëë‚œ í›„,  *closeFile()* (ì¼íšŒì„± ë³€í™”! í•œë²ˆ ë‹«ìœ¼ë©´ FileHandleë¡œ ë‹¤ì‹œ ì—´ì–´ì¤˜ì•¼ë˜ì£ .. )ì„ ì´ìš©í•´ ë‹«ì•„ì£¼ê³ ìžˆìŠµë‹ˆë‹¤. *closeFile()* ì˜ ì•Œë§žì€ í˜¸ì¶œ ìœ„ì¹˜ëŠ” closure ë°–ìž…ë‹ˆë‹¤. 

ë§Œì•½ *closeFile()* ì„ ìž˜ëª»í•´ì„œ closure ë‚´ì— ë„£ì–´ë²„ë¦¬ë©´ 

```swift
lines.forEach { line in
    file.write("\(line)\n".data(using: .utf8)!)
    file.closeFile() // Error
}
```

ì´í›„ Closure í˜¸ì¶œì‹œ ë‹«ížŒ íŒŒì¼ì— ì“°ë ¤ê³  í•˜ê¸° ë•Œë¬¸ì—, ì•±ì´ ì£½ì–´ë²„ë¦½ë‹ˆë‹¤... ðŸ˜«



## Don't Put Critical Code in a Closure That Might Not Be Called

#### ë¶ˆë¦¬ì§€ ì•Šì„ ìˆ˜ë„ ìžˆëŠ” Closureì— ì¤‘ìš”í•œ ì½”ë“œë¥¼ ë„£ì§€ ë§™ì‹œë‹¤! 

ë§Œì•½ Closureê°€ ë¶ˆë¦¬ì§€ ì•Šì„ ìˆ˜ë„ ìžˆë‹¤ë©´, ì•± ì‹¤í–‰ì‹œ ì¤‘ìš”í•œ ì½”ë“œë¥¼ ë„£ìœ¼ë©´ ì•ˆë©ë‹ˆë‹¤. ì•„ëž˜ ì˜ˆì‹œë¥¼ ë³´ë©´ *Lottery* Enumerationì„ ì„ ì–¸í•´ì„œ ë‹¹ì²¨ë²ˆí˜¸ë¥¼ ë½‘ê³ , ë‹¹ì²¨ë˜ì—ˆëŠ”ì§€ í™•ì¸ë˜ëŠ” ì½”ë“œê°€ completion Handler ì— ë“¤ì–´ìžˆìŠµë‹ˆë‹¤. 

```swift
enum Lottery {
    static var lotteryWinHandler: (() -> Void)?
    
    @discardableResult static func pickWinner(guess: Int) {
        print("Running the lottery.")
        if guess == Int.random(in: 0 ..< 100_000_000), let winHandler = lotteryWinHandler {
            winHandler()
            return true
        }
        
        return false
    }
}
```

 Completion handlerì— ì˜ì¡´ì ì¸ ì½”ë“œë¥¼ ì“°ëŠ”ê±´ ìœ„í—˜í•©ë‹ˆë‹¤. ëžœë¤ìœ¼ë¡œ ë½‘ì€ ìˆ˜ê°€ ë‹¹ì²¨ë ê±°ë¼ëŠ” ë³´ìž¥ì´ ì—†ê¸°ë•Œë¬¸ì—, ë‹¹ì²¨ë˜ë©´ ì‹¤í–‰ë˜ëŠ” *paying bills*ì™€ ê°™ì€ ì¤‘ìš”í•œ ì½”ë“œê°€ ì•„ì˜ˆ ì‹¤í–‰ì´ ë˜ì§€ ì•Šì„ ìˆ˜ ìžˆê² ì£ . 



## Reference

[Apple Development Article - Preventing Timing Problems When Using Closures](https://developer.apple.com/documentation/swift/preventing_timing_problems_when_using_closures)
